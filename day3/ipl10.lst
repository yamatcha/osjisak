     1                                  ; hello-os
     2                                  CYLS	EQU		10				; どこまで読み込むか
     3                                      ORG     0x7c00          ; このプログラムがどこに読み込まれるのか
     4                                  
     5                                  ; 以下は標準的なFAT12フォーマットフロッピーディスクのための記述
     6                                  
     7 00000000 EB4D                        JMP     entry
     8 00000002 90                          DB      0x90
     9 00000003 48454C4C4F49504C            DB      "HELLOIPL"      ; ブートセクタの名前を自由に書いてよい（8バイト）
    10 0000000B 0002                        DW      512             ; 1セクタの大きさ（512にしなければいけない）
    11 0000000D 01                          DB      1               ; クラスタの大きさ（1セクタにしなければいけない）
    12 0000000E 0100                        DW      1               ; FATがどこから始まるか（普通は1セクタ目からにする）
    13 00000010 02                          DB      2               ; FATの個数（2にしなければいけない）
    14 00000011 E000                        DW      224             ; ルートディレクトリ領域の大きさ（普通は224エントリにする）
    15 00000013 400B                        DW      2880            ; このドライブの大きさ（2880セクタにしなければいけない）
    16 00000015 F0                          DB      0xf0            ; メディアのタイプ（0xf0にしなければいけない）
    17 00000016 0900                        DW      9               ; FAT領域の長さ（9セクタにしなければいけない）
    18 00000018 1200                        DW      18              ; 1トラックにいくつのセクタがあるか（18にしなければいけない）
    19 0000001A 0200                        DW      2               ; ヘッドの数（2にしなければいけない）
    20 0000001C 00000000                    DD      0               ; パーティションを使ってないのでここは必ず0
    21 00000020 400B0000                    DD      2880            ; このドライブ大きさをもう一度書く
    22 00000024 000029                      DB      0,0,0x29        ; よくわからないけどこの値にしておくといいらしい
    23 00000027 FFFFFFFF                    DD      0xffffffff      ; たぶんボリュームシリアル番号
    24 0000002B 544553542D4F532020-         DB      "TEST-OS   "   ; ディスクの名前（11バイト）
    25 00000034 20                 
    26 00000035 4641543132202020            DB      "FAT12   "      ; フォーマットの名前（8バイト）
    27 0000003D 00<rept>                    TIMES   18 DB 0         ; とりあえず18バイトあけておく
    28                                  
    29                                  ; プログラム本体
    30                                  
    31                                  entry:
    32 0000004F B80000                      MOV     AX,0            ; レジスタ初期化
    33 00000052 8ED0                        MOV     SS,AX
    34 00000054 BC007C                      MOV     SP,0x7c00
    35 00000057 8ED8                        MOV     DS,AX
    36                                  
    37 00000059 B82008                  	MOV		AX,0x0820
    38 0000005C 8EC0                    	MOV		ES,AX
    39 0000005E B500                    	MOV		CH,0			; シリンダ0
    40 00000060 B600                    	MOV		DH,0			; ヘッド0
    41 00000062 B102                    	MOV		CL,2			; セクタ2
    42                                  
    43                                  readloop:
    44 00000064 BE0000                  		MOV		SI,0			; 失敗回数を数えるレジスタ
    45                                  retry:
    46 00000067 B402                    		MOV		AH,0x02			; AH=0x02 : ディスク読み込み
    47 00000069 B001                    		MOV		AL,1			; 1セクタ
    48 0000006B BB0000                  		MOV		BX,0
    49 0000006E B200                    		MOV		DL,0x00			; Aドライブ
    50 00000070 CD13                    		INT		0x13			; ディスクBIOS呼び出し
    51 00000072 7310                    		JNC		next			; エラーがおきなければnextへ
    52 00000074 83C601                  		ADD		SI,1			; SIに1を足す
    53 00000077 83FE05                  		CMP		SI,5			; SIと5を比較
    54 0000007A 7335                    		JAE		error			; SI >= 5 だったらerrorへ
    55 0000007C B400                    		MOV		AH,0x00
    56 0000007E B200                    		MOV		DL,0x00			; Aドライブ
    57 00000080 CD13                    		INT		0x13			; ドライブのリセット
    58 00000082 EBE3                    		JMP		retry
    59                                  next:
    60 00000084 8CC0                    		MOV		AX,ES			; アドレスを0x200進める
    61 00000086 83C020                  		ADD		AX,0x0020
    62 00000089 8EC0                    		MOV		ES,AX			; ADD ES,0x020 という命令がないのでこうしている
    63 0000008B 80C101                  		ADD		CL,1			; CLに1を足す
    64 0000008E 80F912                  		CMP		CL,18			; CLと18を比較
    65 00000091 76D1                    		JBE		readloop		; CL <= 18 だったらreadloopへ
    66 00000093 B101                    		MOV		CL,1
    67 00000095 80C601                  		ADD		DH,1
    68 00000098 80FE02                  		CMP		DH,2
    69 0000009B 72C7                    		JB		readloop		; DH < 2 だったらreadloopへ
    70 0000009D B600                    		MOV		DH,0
    71 0000009F 80C501                  		ADD		CH,1
    72 000000A2 80FD0A                  		CMP		CH,CYLS
    73 000000A5 72BD                    		JB		readloop		; CH < CYLS だったらreadloopへ
    74                                  
    75 000000A7 882EF00F                        MOV     [0x0ff0],CH
    76 000000AB E9(00C2)                        JMP     0xc200
    77                                  
    78                                  fin:
    79 000000AE F4                          HLT                     ; 何かあるまでCPUを停止させる
    80 000000AF EBFD                        JMP     fin             ; 無限ループ
    81                                  error:
    82 000000B1 BE[C600]                	MOV		SI,msg
    83                                  putloop:
    84 000000B4 8A04                        MOV     AL,[SI]
    85 000000B6 83C601                      ADD     SI,1            ; SIに1を足す
    86 000000B9 3C00                        CMP     AL,0
    87 000000BB 74F1                        JE      fin
    88 000000BD B40E                        MOV     AH,0x0e         ; 一文字表示ファンクション
    89 000000BF BB0F00                      MOV     BX,15           ; カラーコード
    90 000000C2 CD10                        INT     0x10            ; ビデオBIOS呼び出し
    91 000000C4 EBEE                        JMP     putloop
    92                                  
    93                                  msg:
    94 000000C6 0A0A                        DB      0x0a, 0x0a      ; 改行を2つ
    95 000000C8 6C6F6164206572726F-         DB      "load error."
    96 000000D1 722E               
    97 000000D3 0A                          DB      0x0a            ; 改行
    98 000000D4 00                          DB      0
    99                                  
   100 000000D5 00<rept>                    TIMES   0x7dfe-($-$$)-0x7c00 DB 0        ; 0x7dfeまでを0x00で埋める命令
   101                                  
   102 000001FE 55AA                        DB      0x55, 0xaa
   103                                  
   104                                  
